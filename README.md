# МТЗП-2 ESP32 Hub
<sub>License: MIT<br>
Platform: ESP32<br>
Version: 2.0</sub><br><br>
**МТЗП-2 ESP32 Hub** — это шлюз на базе ESP32 для устройства защиты МТЗП-2. Проект предоставляет WiFi-доступ к устройству через RS485 с использованием протокола SLIP, веб-интерфейс для мониторинга и настройки, а также REST API для чтения/записи регистров.
Это исправленная и улучшенная версия (v2.0) с фокусом на стабильность протокола, обработку ошибок и удобный пользовательский интерфейс. Поддерживает чтение/запись параметров, групповые операции, тестирование связи и конфигурацию устройства.

# Основные возможности

- WiFi Точка Доступа: Создает AP с SSID MTZP и паролем 12345678 для подключения.<br>
- REST API:<br>
  - /api/read?reg=<номер>: Чтение регистра.<br>
  - /api/write?reg=<номер>&val=<значение>: Запись в регистр.<br>
  - /api/test: Тест связи с МТЗП (чтение серийного номера и даты изготовления).<br>
  - /api/status: Статус системы (uptime, heap, адрес, baud rate).<br>
  - /api/config: Получение/установка адреса и baud rate МТЗП.<br>
  - /api/restart: Перезагрузка ESP32.<br>
- Веб-интерфейс:<br>
  - index.html: Мониторинг параметров (токи, напряжения, защиты, индикаторы), с вкладками и модальными окнами для редактирования.<br>
  - set.html: Настройки (адрес, baud rate), чтение/запись регистров, тест связи.<br>
- Протокол: SLIP над RS485 с CRC16 (реализация из документации МТЗП).<br>
- Хранение настроек: Использует Preferences для сохранения адреса и baud rate.<br>
- Отладка: Опциональный debug-режим через Serial.<br>
- Поддержка: Регистры 0-276, биты для индикаторов (авария, готов, вкл/откл), авторизация по паролям (пользователь/админ/система).<br>

# Требования

- Аппаратное обеспечение:<br>
  - ESP32 (с RS485-трансивером, например, MAX485).<br>
  - Устройство МТЗП-2, подключенное по RS485 (пины RX:16, TX:17, DE:4).<br>
- Программное обеспечение:<br>
  - Arduino IDE с поддержкой ESP32 (esp32 core v2.0+).<br>
  - Библиотеки: ArduinoJson, LittleFS, Preferences, WiFi, WebServer.<br>
- Baud rates: 9600, 19200, 38400, 57600, 115200 (по умолчанию 115200).<br>
- Адрес МТЗП: 0x01-0xFF (по умолчанию 0x12; 0x00 — широковещательный, без ответа).<br>

# Установка


1. Клонируйте репозиторий:
   ```bash
   git clone https://github.com/alex7r259/mtzp_esp32_hub.git
   cd mtzp-esp32-hub
2. Открыть в Arduino IDE:<br>
  - Установите библиотеки через Library Manager: ArduinoJson, LittleFS, Preferences.<br>
  - Загрузите mtzp_hub_little.ino на ESP32.<br>
3. Настройка LittleFS:<br>
  - Используйте ESP32 Sketch Data Upload для загрузки index.html и set.html в LittleFS.<br>
4. Подключение:<br>
  - Подключите RS485 к МТЗП (проверьте baud rate и адрес в настройках МТЗП).<br>
  - ESP32 создаст WiFi AP: подключитесь к MTZP с паролем 12345678.<br>
  - Откройте браузер по IP (по умолчанию 192.168.4.1): http://192.168.4.1/ для мониторинга, /set для настроек.<br><br>

# Использование

## Веб-интерфейс

- Мониторинг (index.html): Отображает параметры в группах (токи, напряжения, защиты). Клик по карточке — редактирование (с авторизацией).
- Настройки (set.html): Изменение адреса/baud rate, чтение/запись регистров, тест связи.
- Авторизация: Ввод пароля для записи (уровни: пользователь — 1, админ — 2, система — 3).

## API Примеры (cURL)

- Чтение регистра 41 (ток фазы A):
   ```bash
   curl "http://192.168.4.1/api/read?reg=41"
- Запись в регистр 100 (пример):
   ```bash
   curl -X POST "http://192.168.4.1/api/write?reg=100&val=500"
- Тест связи:
   ```bash
   curl "http://192.168.4.1/api/test"

## Отладка
- Включите DEBUG_ENABLED = true в коде для вывода в Serial (TX/RX пакеты, ошибки CRC, таймауты).

# Конфигурация
- Изменение AP: В коде AP_SSID и AP_PASS.
- Таймауты: SLIP_TIMEOUT_MS (500мс), BYTE_TIMEOUT_MS (10мс) — для длинных кабелей.
- Baud rates: Массив allowedBaudRates — добавьте/удалите значения.
- Адрес: Через API /api/config?addr=18&baud=115200 (POST).

# Известные проблемы
- Широковещательный адрес (0x00): Нет ответа от МТЗП на запросы.
- Длинные кабели RS485: Увеличьте BYTE_TIMEOUT_MS при ошибках таймаута.
- Мобильный интерфейс: Оптимизирован для смартфонов, но протестируйте на разных устройствах.

# Контрибьютинг
- Форкните репозиторий.
- Создайте feature-бранч (git checkout -b feature/new-feature).
- Коммитьте изменения (git commit -am 'Add new feature').
- Пушьте в бранч (git push origin feature/new-feature).
- Создайте Pull Request.

# Лицензия
MIT License. См. LICENSE для деталей.

# Автор
- alex7r259 — разработчик проекта.
- Контакты: alex7r259@yandex.ru или Issues на GitHub.<br><br>

Если проект полезен — поставьте ⭐️! Для вопросов используйте Issues.
