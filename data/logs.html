<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>МТЗП — Журналы</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        :root {
            --primary: #2196f3; --primary-dark: #1976d2;
            --success: #4caf50; --danger: #f44336; --warning: #ff9800;
            --light: #f5f7fa; --gray: #e0e0e0; --dark-gray: #757575;
            --text: #333; --border: #d1d1d1; --card-bg: #ffffff;
            --header-bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
        html, body { height:100%; font-family: system-ui, sans-serif; background:var(--light); color:var(--text); line-height:1.5; }
        body { padding-bottom:90px; overflow-y:auto; }
        .header {
            background:var(--header-bg); color:white; padding:14px 16px;
            position:sticky; top:0; z-index:100; box-shadow:0 3px 12px rgba(0,0,0,0.12);
        }
        .header-title { font-size:1.35rem; font-weight:600; }
        .header-subtitle { font-size:0.9rem; opacity:0.92; margin-top:3px; }
        .main-content { padding:16px; padding-bottom:24px; }
		.tabs {
    		display:flex;
			overflow-x:auto;
			gap:8px;
			padding:10px 8px;
			background:white;
			border-bottom:1px solid var(--border);
			position:sticky;
			top:56px;
			z-index:99;
		}
		.tabs::-webkit-scrollbar { display:none; }
        .tab {
            padding:10px 20px; white-space:nowrap; border-radius:24px;
            background:#f1f3f5; font-weight:500; cursor:pointer; flex-shrink:0;
            transition: all 0.2s;
        }
        .tab.active { background:var(--primary); color:white; }
        .card {
            background:var(--card-bg); border-radius:12px; padding:18px;
            border:1px solid var(--border); margin:16px 0; box-shadow:0 3px 10px rgba(0,0,0,0.07);
        }
        .stats { display:flex; justify-content:space-between; margin:14px 0; font-size:0.98rem; flex-wrap:wrap; gap:10px; }
        .stats strong { color:var(--primary-dark); font-weight:600; }
        .controls { display:flex; flex-wrap:wrap; gap:12px; margin:18px 0; align-items:center; }
        .btn {
            padding:12px 20px; border:none; border-radius:8px; font-weight:500;
            cursor:pointer; transition:all 0.22s; min-width:130px; font-size:1rem;
        }
        .btn-primary  { background:var(--primary);  color:white; }
        .btn-success  { background:var(--success);  color:white; }
        input[type="number"] {
            width:110px; padding:11px; border:1px solid var(--border);
            border-radius:6px; font-size:1rem; text-align:center;
        }
        .table-container { overflow-x:auto; margin-top:14px; }
        table { width:100%; min-width:620px; border-collapse:collapse; font-size:0.93rem; }
        th, td { padding:11px 10px; text-align:left; border-bottom:1px solid #eee; }
        th { background:#f9fafb; font-weight:600; color:#444; position:sticky; top:0; z-index:1; }
        tr:hover { background:#f0f8ff; cursor:pointer; }
        .pagination {
            display:flex; justify-content:center; align-items:center; gap:20px;
            margin:24px 0; font-size:1.05rem; flex-wrap:wrap;
        }
        .page-btn {
            padding:10px 20px; border-radius:8px; background:#f0f0f0; cursor:pointer;
            min-width:110px; text-align:center; user-select:none;
        }
        .page-btn.disabled { opacity:0.45; pointer-events:none; }
        .loading { text-align:center; padding:60px 0; color:var(--dark-gray); font-size:1.15rem; }
		.record-detail {
    		background:white;
			padding:16px;
			border-radius:12px;
			margin:16px 0;
			font-family:system-ui, sans-serif;
			white-space:pre-line;
			font-size:0.95rem;
			border:1px solid var(--border);
			line-height:1.6;
		}
        .bottom-nav {
            position:fixed; bottom:0; left:0; right:0; background:white;
            display:flex; justify-content:space-around; padding:12px 0;
            border-top:1px solid var(--border); z-index:100; box-shadow:0 -3px 12px rgba(0,0,0,0.06);
        }
        .nav-item {
            display:flex; flex-direction:column; align-items:center; gap:5px;
            padding:8px 14px; color:var(--dark-gray); text-decoration:none;
            font-size:0.88rem; flex:1; max-width:100px; border-radius:12px;
            transition: all 0.2s;
        }
        .nav-item.active { color:var(--primary); background:rgba(33,150,243,0.1); }
        @media (max-width: 480px) {
            .btn, input[type="number"] { font-size:0.96rem; padding:10px 14px; min-width:110px; }
            .table-container { margin-left:-16px; margin-right:-16px; }
        }
		
		.mobile-list { display: none; }
		
		.record-card {
    		background:white;
			border-radius:12px;
			padding:14px;
			margin:10px 0;
			border:1px solid var(--border);
			box-shadow:0 2px 6px rgba(0,0,0,0.05);
		}
		
		.record-header {
    		display:flex;
			justify-content:space-between;
			font-weight:600;
			margin-bottom:6px;
		}

.record-time {
    font-size:0.9rem;
    color:var(--dark-gray);
}

.record-event {
    margin-top:6px;
    font-weight:500;
}

.record-source {
    font-size:0.85rem;
    color:var(--dark-gray);
}

.record-card.alarm {
    border-left:5px solid var(--danger);
}

.record-card.fault {
    border-left:5px solid var(--warning);
}

/* На мобильном скрываем таблицу */
@media (max-width: 768px) {
    table { display:none; }
    .mobile-list { display:block; }
}
.tab { font-size:0.95rem; }
.page-btn { font-size:1rem; }
.btn { font-size:1rem; }
.bit-list {
    margin:6px 0 12px 0;
    padding-left:18px;
}

.bit-list li {
    margin:4px 0;
    font-size:0.95rem;
}

    </style>
</head>
<body>

    <div class="header">
        <div class="header-title">Журналы событий МТЗП</div>
        <div class="header-subtitle">МТЗП-2 / МТЗП-1200</div>
    </div>

    <div class="main-content">

        <div class="tabs" id="tabs"></div>

        <div id="content" class="card" style="display:none;">
            <h3 id="journalName"></h3>

            <div class="stats">
                <span>Всего записей:</span> <strong id="total">—</strong>
            </div>

            <div class="controls">
                <button class="btn btn-primary" onclick="refresh()">Обновить</button>
                <button class="btn btn-success" onclick="loadLatest()">Последние 10</button>
                <input type="number" id="jumpIdx" placeholder="№ записи" min="1">
                <button class="btn btn-primary" onclick="jumpTo()">Перейти</button>
            </div>

            <div id="detail" class="record-detail" style="display:none;"></div>

            <div id="loading" class="loading">Загрузка данных...</div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>№</th>
                            <th>Время</th>
                            <th>Событие</th>
                            <th>Источник</th>
                        </tr>
                    </thead>
                    <tbody id="tbody"></tbody>
                </table>
            </div>
			<div id="mobileList" class="mobile-list"></div>

            <div class="pagination">
                <div class="page-btn" id="prev" onclick="changePage(-1)">« Назад</div>
                <span>страница <b id="pageNum">1</b> из <b id="maxPage">—</b></span>
                <div class="page-btn" id="next" onclick="changePage(1)">Вперёд »</div>
            </div>
        </div>

    </div>

    <div class="bottom-nav">
        <a href="/" class="nav-item">
            <i class="fas fa-home fa-lg"></i><span>Главная</span>
        </a>
        <a href="/logs" class="nav-item active">
            <i class="fas fa-book fa-lg"></i><span>Журналы</span>
        </a>
    </div>

    <script>

const journals = [
    { id: 'alarm',     name: 'Аварии' },
    { id: 'fault',     name: 'Неисправности' },
    { id: 'setchange', name: 'Изменение уставок' },
    { id: 'comm',      name: 'Вкл/Откл КА' },
    { id: 'poweron',   name: 'Включение/отключение питания' },
    { id: 'diag',      name: 'Диагностика' },
    { id: 'powerlog',  name: 'Потребляемая мощность' }
];

let currentJournal = null;
let totalRecords = 0;
let currentPage = 1;
const recordsPerPage = 10;

const eventCodes = {
    0x00: "Отключение КА",
    0x01: "Включение КА",
    0x04: "Аппаратный сброс процессора",
    0x05: "Отключение оперативного питания",
    0x06: "Включение оперативного питания",
    0x07: "Диагностика БКИ",
    0x08: "Диагностика ДТ",
    0x09: "Диагностика ТНП",
    0x0A: "Отключение контактора",
    0x0B: "Включение контактора"
};

const sources = {
    0x10: "ПДУ-1", 0x20: "ПДУ-2", 0x30: "МПУ",
    0x40: "ПТУ-1", 0x50: "ПТУ-2", 0x60: "АПВ",
    0x70: "АВР",   0x80: "Опер.питание", 0x90: "Авария",
    0xA0: "Самодиагностика"
};

const stateRegisterMap = {
  0:  'Напряжение секции шин',
  1:  'Режим пуска',
  2:  'Закончился старт',
  3:  'Отладочный режим',
  4:  'Разрешена корректировка нулей АЦП',
  5:  'Доступ к FRAM и RTC',
  8:  'АВАРИЯ',
  9:  'ГОТОВ',
 10:  'ВКЛ',
 11:  'ОТКЛ',
 13:  'Потеря связи с блоком индикации',
 14:  'Ошибка I2C (часы)',
 15:  'Ошибка EEPROM'
};

const alarmReg1Map = {
  0: 'МТЗ-1 – защита по току',
  1: 'МТЗ-2 – защита по току',
  2: 'МТЗ-3 – защита по току',
  3: 'УМТЗ – защита по току',
  4: 'Тест БКИ – диагностика БВР',
  5: 'Тест ДТ – диагностика ДТ',
  6: 'Тест ТНП – диагностика ТНП',
  8: 'INP_3 – местная защита',
  9: 'INP_2 – местная защита',
 10: 'INP_1 – местная защита',
 11: 'INP_4 – местная защита',
 12: 'БКИ – утечка по сопротивлению',
 13: 'SWT – авария КА',
 14: 'BUS – потеря питания секции шин',
 15: 'INP_Z – внутренняя ошибка БЗУ'
};

const alarmReg2Map = {
  0: 'EXT1 – внешняя защита',
  1: 'EXT2 – внешняя защита',
  2: 'EXT3 – внешняя защита',
  3: 'EXT4 – внешняя защита',
  4: 'ЗМН мин. – минимальное напряжение',
  5: 'ЗМН макс. – максимальное напряжение',
  6: 'ЗОФ – обрыв фаз',
  7: 'ЗНФ – несимметрия фаз',
  8: 'НЗЗ – направленная земляная защита',
  9: 'ЗМТ – минимальный ток',
 10: 'УРО – резервное отключение',
 11: 'СТОП – авария кнопки СТОП',
 12: 'EXT_KZ – КЗ на внешнем входе',
 15: 'DIR – прямое управление'
};

const faultReg1Map = alarmReg1Map;
const faultReg2Map = alarmReg2Map;

const relayMap = {
  0: 'K1 ВКЛ1', 1: 'K2 ВКЛ2', 2: 'K3 ОТКЛ', 3: 'K4 УРОВ',
  4: 'K5 Uсш', 5: 'K6 Пуск МТЗ', 6: 'K7 МТЗ-1', 7: 'K8 Авария',
  8: 'K9 Авария', 9: 'K10 Положение', 10: 'K11 УРОВ', 11: 'K12 Пуск МТЗ',
 12: 'Тест БВР',
 13: 'Тест ДТ',
 14: 'Тест ТНП'
};

const ext1Map = {
  0: 'Внешнее отключение (ИЦ)', 1: 'АГЗ', 2: 'Резерв', 3: 'ПДУ'
};

const ext2Map = {
  0: 'Резерв', 1: 'ЛЗШ (ИЦ)', 2: 'Резерв'
};

const intMap = {
  0: 'РПО', 1: 'РПВ', 2: 'Контроль БП (М1)', 3: 'Дуговая защита (М2)',
  4: 'МТЗ ПД (М3)', 5: 'Кнопка ОТКЛ', 6: 'Кнопка ВКЛ', 7: 'Кнопка Сброс',
  8: 'Кнопка Тест ДТ', 9: 'Кнопка Тест БВР', 10: 'Кнопка Тест НЗЗ', 11: 'ЛЗШ',
 12: 'АВР-1',
 13: 'АВР-2',
 14: 'Резерв'
};

function getWord(bytes, idx) {
    const hi = parseInt(bytes[idx * 2], 16) || 0;
    const lo = parseInt(bytes[idx * 2 + 1], 16) || 0;
    return (hi << 8) | lo;   // big-endian
}

function decodeBits(value, map) {

    const active = [];

    for (let bit in map) {
        const b = parseInt(bit);
        if (value & (1 << b)) {
            active.push({
                bit: b,
                text: map[bit]
            });
        }
    }

    if (!active.length) {
        return '<span style="color:#999;">—</span>';
    }

    // сортируем по номеру бита
    active.sort((a, b) => a.bit - b.bit);

    let html = '<ul class="bit-list">';
    active.forEach(item => {
        html += `<li><b>[${item.bit}]</b> ${item.text}</li>`;
    });
    html += '</ul>';

    return html;
}

function decodeGenericInputs(value, label) {
    const active = [];
    for (let i = 0; i < 16; i++) {
        if (value & (1 << i)) {
            active.push(`${label}${i}`);
        }
    }
    return active.length ? active.join(", ") : "—";
}


function parseTime(bytes) {
    if (bytes.length < 6) return "—";

    const w0 = getWord(bytes, 0);
    const w1 = getWord(bytes, 1);
    const w2 = getWord(bytes, 2);

    const min  = (w0 >> 8) & 0xFF;
    const sec  = w0 & 0xFF;
    const day  = (w1 >> 8) & 0xFF;
    const hour = w1 & 0xFF;
    const year = 2000 + ((w2 >> 8) & 0xFF);
    const mon  = w2 & 0xFF;

    // Простая проверка валидности
    if (mon < 1 || mon > 12 || day < 1 || day > 31 ||
        hour > 23 || min > 59 || sec > 59) {
        return "Некорректное время";
    }

    const pad = n => String(n).padStart(2, '0');
    return `${pad(day)}.${pad(mon)}.${year} ${pad(hour)}:${pad(min)}:${pad(sec)}`;
}

function parseEventSource(bytes) {
    if (bytes.length < 8) return { event: "—", source: "—" };

    const word = getWord(bytes, 3);

    const sourceCode = (word >> 8) & 0xFF;
    const eventCode  = word & 0xFF;

    return {
        event:  eventCodes[eventCode] || `0x${eventCode.toString(16).padStart(2,'0')}`,
        source: sources[sourceCode]   || `0x${sourceCode.toString(16).padStart(2,'0')}`
    };
}

function getDWord(bytes, idx) {
    const hi = getWord(bytes, idx);
    const lo = getWord(bytes, idx + 1);
    return (hi << 16) | lo;
}

function decodeAlarmOrFault(bytes) {

    const time = parseTime(bytes);
    const es = parseEventSource(bytes);

    const scaleI = 1;   // при необходимости изменить
    const scaleU = 1;
    const scaleR = 1;
    const scaleT = 1;
	
	const errorReg1 = getWord(bytes,27);
	const errorReg2 = getWord(bytes,28);
	const warnReg1  = getWord(bytes,29);
	const warnReg2  = getWord(bytes,30);
	const stateReg  = getWord(bytes,31);
	
    return `
Время:       ${time}
Событие:     ${es.event}
Источник:    ${es.source}

Токи: ${(getWord(bytes,5)  * scaleI).toFixed(1)}/${(getWord(bytes,6)  * scaleI).toFixed(1)}/${(getWord(bytes,7)  * scaleI).toFixed(1)} A
  Imax = ${(getWord(bytes,8)  * scaleI).toFixed(1)} A, I0 = ${(getWord(bytes,16) * scaleI).toFixed(1)} A
Напряжения: ${(getWord(bytes,9)  * scaleU).toFixed(1)}/${(getWord(bytes,10) * scaleU).toFixed(1)}/${(getWord(bytes,11) * scaleU).toFixed(1)} В
  V0  = ${(getWord(bytes,15) * scaleU).toFixed(1)} В, Vab = ${(getWord(bytes,18) * scaleU).toFixed(1)} В

Сопротивление утечки: ${(getWord(bytes,12) * scaleR).toFixed(1)}/${(getWord(bytes,13) * scaleR).toFixed(1)}/${(getWord(bytes,14) * scaleR).toFixed(1)}
Угол (I0-V0): ${getWord(bytes,17)}°
Температура: ${(getWord(bytes,19) * scaleT).toFixed(1)} °C

Пуск: Ipusk = ${getWord(bytes,20)}, Upusk = ${getWord(bytes,21)}, Tpusk = ${getWord(bytes,22)}
  
Реле:
  ${decodeBits(getWord(bytes,23), relayMap)}

Аварии:
  ${decodeBits(errorReg1, alarmReg1Map)}
  ${decodeBits(errorReg2, alarmReg2Map)}

Неисправности:
  ${decodeBits(warnReg1, faultReg1Map)}
  ${decodeBits(warnReg2, faultReg2Map)}

Состояние устройства:
  ${decodeBits(stateReg, stateRegisterMap)}

Входы:
  EXT1: ${decodeBits(stateReg, ext1Map)}
  EXT2: ${decodeBits(stateReg, ext2Map)}
  INT : ${decodeBits(stateReg, intMap)}
`;
}

function decodeSetChange(bytes) {
    const time = parseTime(bytes);
    const w3 = getWord(bytes, 3);

    const sourceCode = (w3 >> 8) & 0xFF;
    const param = w3 & 0xFF;

    return `
Время:          ${time}
Источник:       ${sources[sourceCode] || sourceCode}
Параметр №:     ${param}

Старое значение: ${getWord(bytes,4)}
Новое значение:  ${getWord(bytes,5)}
    `;
}

function decodeSimple(bytes) {
    const time = parseTime(bytes);
    const es = parseEventSource(bytes);
    return `
Время:    ${time}
Событие:  ${es.event}
Источник: ${es.source}
    `;
}

function decodePowerlog(bytes) {
    const time = parseTime(bytes);

    const power = getWord(bytes,3);
    const cos = getWord(bytes,4) / 1000;

    return `
Время:              ${time}
Активная мощность:  ${power} Вт
Cos φ:              ${cos.toFixed(3)}
    `;
}

function initTabs() {
    const tabs = document.getElementById('tabs');
    journals.forEach((j, i) => {
        const tab = document.createElement('div');
        tab.className = 'tab';
        tab.textContent = j.name;
        tab.onclick = () => selectJournal(j, i);
        tabs.appendChild(tab);
    });
    selectJournal(journals[0], 0);
}

async function selectJournal(journal, tabIndex) {
    currentJournal = journal;
    currentPage = 1;

    document.getElementById('content').style.display = 'block';
    document.getElementById('journalName').textContent = journal.name;

    document.querySelectorAll('.tab').forEach((t, i) => {
        t.classList.toggle('active', i === tabIndex);
    });

    await loadPage(currentPage);
}

async function loadPage(pageNum) {
    currentPage = pageNum;
    const start = (pageNum - 1) * recordsPerPage + 1;

    document.getElementById('loading').style.display = 'block';
    document.getElementById('tbody').innerHTML = '';

    try {
        const resp = await fetch(`/api/journal?type=${currentJournal.id}&idx=${start}&count=${recordsPerPage}`);
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);

        const data = await resp.json();

        if (!data.ok) {
            alert("Ошибка сервера: " + (data.error || "неизвестная ошибка"));
            return;
        }

        totalRecords = data.total_records || 0;
        document.getElementById('total').textContent = totalRecords;
        document.getElementById('maxPage').textContent = Math.ceil(totalRecords / recordsPerPage) || 1;

        renderTable(data.records || []);
        updatePagination();
    } catch (err) {
        console.error(err);
        document.getElementById('tbody').innerHTML = `<tr><td colspan="4" style="text-align:center; color:#f44336;">Ошибка загрузки: ${err.message}</td></tr>`;
    } finally {
        document.getElementById('loading').style.display = 'none';
    }
}

function renderTable(records) {

    const tbody = document.getElementById('tbody');
    const mobileList = document.getElementById('mobileList');

    tbody.innerHTML = '';
    mobileList.innerHTML = '';

    records.forEach(rec => {

        const bytes = rec.raw_hex.split(/\s+/).filter(Boolean);
        const time = parseTime(bytes);

        let event = "—", source = "—";
        if (currentJournal.id !== "powerlog") {
            const es = parseEventSource(bytes);
            event = es.event;
            source = es.source;
        }

        /* ==== ДЕСКТОП ТАБЛИЦА ==== */
        const tr = document.createElement('tr');
        tr.onclick = () => showDetail(rec);
        tr.innerHTML = `
            <td>${rec.idx}</td>
            <td>${time}</td>
            <td>${event}</td>
            <td>${source}</td>
        `;
        tbody.appendChild(tr);

        /* ==== МОБИЛЬНАЯ КАРТОЧКА ==== */

        const card = document.createElement('div');
        card.className = 'record-card';

        if (currentJournal.id === "alarm")
            card.classList.add("alarm");

        if (currentJournal.id === "fault")
            card.classList.add("fault");

        card.onclick = () => showDetail(rec);

        card.innerHTML = `
            <div class="record-header">
                <div>#${rec.idx}</div>
                <div class="record-time">${time}</div>
            </div>
            <div class="record-event">${event}</div>
            <div class="record-source">${source}</div>
        `;

        mobileList.appendChild(card);
    });
}

function showDetail(rec) {
    const bytes = rec.raw_hex.split(/\s+/).filter(Boolean);
    let text = "Не удалось декодировать запись";

    switch (currentJournal.id) {
        case "alarm":
        case "fault":
            text = decodeAlarmOrFault(bytes);
            break;
        case "setchange":
            text = decodeSetChange(bytes);
            break;
        case "powerlog":
            text = decodePowerlog(bytes);
            break;
        default:
            text = decodeSimple(bytes);
    }

    const detail = document.getElementById('detail');
    detail.innerHTML = text;
    detail.style.display = 'block';
    detail.scrollIntoView({ behavior: 'smooth', block: 'center' });
}

function updatePagination() {
    document.getElementById('pageNum').textContent = currentPage;
    const max = Math.ceil(totalRecords / recordsPerPage);
    document.getElementById('prev').classList.toggle('disabled', currentPage <= 1);
    document.getElementById('next').classList.toggle('disabled', currentPage >= max);
}

function changePage(delta) {
    const max = Math.ceil(totalRecords / recordsPerPage);
    let newPage = currentPage + delta;
    if (newPage < 1) newPage = 1;
    if (newPage > max) newPage = max;
    if (newPage !== currentPage) loadPage(newPage);
}

function refresh() {
    loadPage(currentPage);
}

function loadLatest() {
    loadPage(1);
}

function jumpTo() {
    const idx = parseInt(document.getElementById('jumpIdx').value);
    if (!idx || idx < 1) return;
    const page = Math.floor((idx - 1) / recordsPerPage) + 1;
    loadPage(page);
}

window.onload = initTabs;

    </script>
</body>
</html>
